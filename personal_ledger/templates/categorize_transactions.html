{% extends "layout.html" %}
{% block content %}
    <form action="{{ url_for(".transactions_bulk_create") }}" method="post" id="transactions_form">
    <input type="submit" />
    <input type="hidden" name="num_columns" value="{{ select_columns.__len__() if select_columns }}" />
    <select id="source_account_id"></select>
  {% if lines %}
<table class="table table-striped table-bordered">
  {% if select_columns %}
  <tr>
    {% for selection in select_columns %}
    <th><select id='selection_{{ loop.index - 1 }}' ></select>
    </th>
    {% endfor %}
    <th></th>
  </tr>
  {% endif %}
  {% for line, select_expense in pairs %}
  <tr id="row_{{ loop.index - 1}}">
    {% for item in line %}
    <td>{{ item }}</td>
    {% endfor %}
    <td>
      <select id='select_expenses_{{ loop.index - 1 }}' ></select>
    <a id="add_rule_for_{{ loop.index - 1 }}" class="btn" type="button">Add Rule</a>
    </td>
  </tr>
  {% endfor %}
</table>
{% endif %}
</form>


    <div class="modal fade" id="add_rule">
        <div class="modal-header">

        </div>
        <div class="modal-body">
            Hello, world!
        </div>
        <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">Close</a>
        </div>
    </div>
{% endblock %}



{% block js_footer_extra %}
<script type="text/javascript">
    (function() {
var getDescriptionColumnIndex = function() {
    for (var i = 0; i < {{ select_columns.__len__() }}; i++) {
        var select = $("#selection_" + i).get(0);
        if (select.options[select.selectedIndex].text == "Description") {
            return select.selectedIndex;
        }
    }
    return -1;
};

var createClickHandler = function(i, accounts_map) {
    return function() {
        var description_column_index = getDescriptionColumnIndex();
        var regex = "";
        if (description_column_index >= 0) {
            regex = $("#row_" + i + " td:eq(" + description_column_index + ")").text();
        }

        var select_expense = $("#select_expenses_" + i).get(0);
        var select_expense_selected = select_expense.options[select_expense.selectedIndex].text;

        $.post("{{ url_for('.rules_new_partial') }}", {
            account_id: accounts_map[select_expense_selected],
            regex: regex,
            weight: 1
        }, function(data) {
            $("#add_rule .modal-body").html(data);
            $("#add_rule").modal();

        });
        return false;
    };
};

var createSelectHandler = function(i) {
    return function() {
        var select = $("#select_expenses_" + i).get(0);
        var selectText = select.options[select.selectedIndex].text;
        if (selectText == "Uncategorized") {
            $("#select_expenses_" + i).addClass("uncategorized");
        }
        else
        {
            $("#select_expenses_" + i).removeClass("uncategorized");
        }

    }
}

var populateSelects = function(accounts_map) {
    for (var i = 0; i < {{ select_columns.__len__() }}; i++) {
        {% for option in options %}
            $('#selection_' + i)
                    .append($("<option/>")
                    .attr("value", "{{ option.title }}")
                    .text("{{ option.title }}"));
        {% endfor %}

    }
        {% for option in options %}
            {% set outer_loop = loop %}
            {% for select in select_columns %}
                {% if option.title == select.title %}
                    $('#selection_{{ loop.index - 1 }} option').eq({{ outer_loop.index - 1}}).prop('selected', true);
                {% endif %}
            {% endfor %}
        {% endfor %}

    for (var i = 0; i < {{ pairs.__len__() }}; i++) {
        {% for account in accounts %}
            $("#select_expenses_" + i)
                    .append($("<option/>")
                            .attr("value", "{{ account.id }}")
                            .text("{{ account.full_title }}"));
        {% endfor %}
    }

    {% for account in accounts %}
        $("#source_account_id")
            .append($("<option/>")
                        .attr("value", "{{ account.id }}")
                        .text("{{ account.full_title }}"));
    {% endfor %}

    {% for account in accounts %}
        accounts_map["{{ account.full_title }}"] = {{ account.id }};
    {% endfor %}

    {% for account in accounts %}
        {% set outer_loop = loop %}
        {% for line, select_expense in pairs %}
            {% if select_expense.id == account.id %}
                $("#select_expenses_{{ loop.index - 1 }} option").eq({{ outer_loop.index - 1 }}).prop('selected', true);
            {% endif %}
        {% endfor %}
    {% endfor %}

    for (var i = 0; i < {{ pairs.__len__() }}; i++) {
        var selectHandler = createSelectHandler(i)
        $("#select_expenses_" + i).change(selectHandler);

        // call once to initialize
        selectHandler();
    }
};

$(function() {
    var numTransactions = {{ pairs.__len__() }};

    var accounts_map = {};
    populateSelects(accounts_map);

    for (var i = 0; i < numTransactions; i++) {
        $("#add_rule_for_" + i).click(createClickHandler(i, accounts_map));
    }
/*
    $("#transactions_form").submit(function() {
        var columns = [];
        for (var i = 0; i < numColumns; i++) {
            columns[i] = $("#selection_" + i).val();
        }

        var data = {}
        for (var i = 0; i < numTransactions; i++) {
            for (var j = 0; j < numColumns; j++) {
                var column = columns[j];
                data["row_" + i + "_" + column] = $("#row_" + i + " td:eq(" + j + ")").text();
            }
        }

        $.post(data, function() {
            console.log("Submitted");

        });
        return false;
    });
    */
});

    })();
</script>
{% endblock %}
